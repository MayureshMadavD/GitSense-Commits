# Activity Summary for 01/12/2025

## 12:05:31
The changes logged primarily concern two files: `/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/common/services/ForeignAnalytics.ts` and `/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/public/merchant.html`. The `EnvironmentService.ts` file has been excluded from the summary as requested.

### File-Specific Updates:

**1. `/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/common/services/ForeignAnalytics.ts`**

This TypeScript file, responsible for foreign analytics tracking, saw frequent updates between 10:52:47 and 20:53:50 on 30/11/2025. The core of these changes revolved around refining how various price-related variables (`totalValue`, `cart_total_price`, `cart_after_discount`, `priceBreakup.order_total`, `gaTotalAmount`) are updated and derived from different data stores (`store_priceBreakUp` and `store_totalPrice`).

**Key changes and their timestamps:**

*   **30/11/2025, 11:07:20:** Introduced a `console.log` statement in `store_priceBreakUp.subscribe` for debugging "Price Break Up Amount".
*   **30/11/2025, 11:09:18:** Modified logic within `store_priceBreakUp.subscribe` to directly set `totalValue = res?.total`. The `store_totalPrice.subscribe` block was updated to conditionally assign `totalValue`, `priceBreakup.order_total`, `gaTotalAmount`, and `commonAnalyticsData['cart_after_discount']`, prioritizing the existing `totalValue` if already set.
*   **30/11/2025, 11:12:36:** Refined the conditional assignment logic in `store_totalPrice.subscribe` for `totalValue`, `priceBreakup.order_total`, `gaTotalAmount`, and `commonAnalyticsData['cart_after_discount']` to explicitly use `totalValue = totalValue ? totalValue : res;` pattern.
*   **30/11/2025, 11:13:09:** Added `console.log` statements for debugging `finalPayablePrice` and `totalValue` from `priceBreakUp` store. These were quickly added and then removed.
*   **30/11/2025, 11:43:08:** Introduced a new variable `priceBreakupObject` to capture the `res` from `store_priceBreakUp.subscribe` before assigning `totalValue`.
*   **30/11/2025, 11:51:35:** Declared new variables `cart_total_price` and `cart_after_discount`. The `store_priceBreakUp.subscribe` block was updated to assign these new variables using `cart.original_total_price` and `cart.total_price`. The `isTotalPayableAmount` variable was removed from declarations and usages.
*   **30/11/2025, 11:56:39:** The `priceBreakupObject` variable was removed, and its assignments were integrated directly. Debugging `console.log` statements were also removed from both `store_priceBreakUp.subscribe` and `store_totalPrice.subscribe`.
*   **30/11/2025, 12:03:21:** The logic for `cart_total_price` and `cart_after_discount` was removed from `store_priceBreakUp.subscribe`. `totalValue` assignment within this block was simplified to `totalValue = res?.total;`.
*   **30/11/2025, 12:04:30:** `cart_total_price` and `cart_after_discount` declarations were re-added. The `store_totalPrice.subscribe` block was adjusted to use the derived `totalValue` for `priceBreakup.order_total` and `gaTotalAmount`.
*   **30/11/2025, 12:09:15:** `cart_total_price` and `cart_after_discount` were explicitly calculated and assigned within the `store_totalPrice.subscribe` block using `cart.original_total_price` and `cart.total_price`, respectively.
*   **30/11/2025, 12:20:53:** A temporary `console.log("Triggered")` was added before `store_totalPrice.subscribe`.
*   **30/11/2025, 12:25:10:** Optional chaining (`cart?.original_total_price`, `cart?.total_price`) was introduced for `cart_total_price` and `cart_after_discount` assignments within `store_totalPrice.subscribe`.
*   **30/11/2025, 12:27:27:** `cart_total_price` and `cart_after_discount` assignments were moved from `store_totalPrice.subscribe` back to `store_priceBreakUp.subscribe`, retaining optional chaining.
*   **30/11/2025, 12:34:05:** Introduced a significant logic update for `cart_total_price` and `cart_after_discount` within `store_priceBreakUp.subscribe`. These variables now prioritize values from `res?.subTotal` and `res?.total` respectively, falling back to `cart` object values if `res` does not provide them.
*   **30/11/2025, 12:35:05:** `cart_total_price` and `cart_after_discount` were initialized at their declaration with default values derived from `cart` using optional chaining.

**2. `/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/public/merchant.html`**

This HTML file serves as a merchant page with embedded JavaScript for the GoKwik SDK. The single log entry for this file at **30/11/2025, 12:22:55** shows:

*   **GoKwik SDK Integration:** Defines a `gokwikSdk` IIFE (Immediately Invoked Function Expression) to manage script loading, payment processing (`initCheckout`), event handling (`on`, `emit`), and UI manipulations (`hideButton`).
*   **Dynamic Script Loading:** The `init` function within `gokwikSdk` dynamically appends a GoKwik JavaScript bundle (`http://localhost:8080/build/gokwik.js` for local environment) to the document head. It also handles removing `.gokwik-disabled` classes and `#line_r_gokwik` elements if present.
*   **Cookie Management:** Includes JavaScript functions (`getCookieGk`, `setCookieGk`) to manage `gk_landing_page` and `gk_orig_referrer` cookies, setting them if they don't already exist.
*   **Merchant Configuration:** A `window.merchantInfo` object is defined with an `environment: 'local'` and a `storeId`, along with a `fbpixel` ID. Several commented-out `mid` (merchant ID) values suggest a history of testing across various environments and merchants.
*   **Checkout Trigger:** A `gokwik-button` with `data-mid`, `data-appid`, `data-appsecret` is provided to initiate the `goKwikCheckout` function, which posts `merchantInfo` to the window.
*   **Event Listeners:** The page sets up `document.onreadystatechange` and `document.addEventListener('initGKJS')` to initialize the `gokwikSdk`. It also has a `window.onmessage` listener to respond to a "Gokwik ready!" message.

### Patterns and Recurring Elements:

*   **Debugging (`console.log`):** In `ForeignAnalytics.ts`, there's a recurring pattern of adding and then removing `console.log` statements. This suggests active debugging and refinement of the price calculation and data flow logic.
*   **Event-Driven Architecture:** Both files demonstrate an event-driven pattern. `ForeignAnalytics.ts` uses Svelte stores (`store_discountAmount`, `store_priceBreakUp`, etc.) with `subscribe` methods to react to data changes. `merchant.html` uses `window.postMessage` for cross-origin communication and custom events (`initGKJS`) for SDK initialization.
*   **Environment-Specific Configuration:** The `merchant.html` explicitly uses `environment: 'local'` for `window.merchantInfo` and lists multiple commented-out `mid` values, indicating a common practice of testing and configuring for different deployment environments.
*   **Price Calculation Refinement:** In `ForeignAnalytics.ts`, a major ongoing effort is visible to correctly and robustly calculate and assign total prices, original cart prices, and discounted prices, with repeated adjustments to prioritize different data sources (`res` from store updates vs. `cart` object). This indicates that accurately capturing and attributing financial metrics for analytics is a critical and evolving aspect of the codebase.
*   **Optional Chaining:** The use of optional chaining (`?.`) in object property access (e.g., `res?.total`, `cart?.original_total_price`) is consistently applied to handle potentially undefined values gracefully.

## 12:05:55
The code changes primarily revolve around the integration and refinement of a "KwikPass" checkout flow within an Appmaker Expo React Native application, heavily relying on a WebView component.

**File-Specific Updates:**

1.  **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/.env`**:
    *   This file saw frequent changes to the `EXPO_PUBLIC_APPMAKER_PROJECT_ID`. It toggled between `194419` (The Derma Co.) and `183929` (sandbox-plus) multiple times, suggesting switching between production and sandbox environments for testing or deployment. The `EXPO_PUBLIC_DISABLE_SHOPIFY_API_DEPRECATION_WARNING` setting remained consistently `true`.

2.  **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/packages/kwikpassV2/src/components/KwikPassCheckout.js` (and similar `src/kwikpassV2/` paths):**
    *   **Initial Implementation (27/11/2025, 18:51:28)**: Introduced the `KwikPassCheckout` React Native component. This component acts as an intermediary, using `KPCheckout` from an external package to render a WebView. It contains an `onEvent` handler to process messages from the WebView, specifically for `modal_closed`, `orderSuccess`, `openInBrowserTab`, and `gk-checkout-disable` events. The `orderSuccess` case initially extracted Shopify `orderID` and `orderKey` from GraphQL GID and checkout URL regexes, then dispatched a `SET_ORDER_COMPLETE` action and conditionally handled user login.
    *   **Debugging and `orderKey` Bug (27/11/2025, 22:53:59 - 23:06:37)**: Numerous `console.log` statements were added, particularly within the `orderSuccess` event handler, indicating active debugging. During this period, a recurring bug was introduced where the `matches` variable, crucial for extracting `orderKey`, was either not properly defined or was removed, leading to errors.
    *   **`orderKey` Bug Fix (27/11/2025, 23:16:36)**: The logic for extracting `orderKey` was fixed by reintroducing `orderKeyRegex` and `orderKeyRegexExtra` to robustly match patterns in the `checkoutUrl`.
    *   **Major Refactoring & Reversion (27/11/2025, 23:30:22 - 23:50:11)**: A significant change at 23:30:22 modified the `orderSuccess` flow to *directly redirect* the user to the `checkoutUrl` within a WebView using `OPEN_IN_WEBVIEW` and removed the `SET_ORDER_COMPLETE` action. However, this change was largely *reverted* by 23:50:11, returning to the previous approach of extracting `orderKey` and calling `SET_ORDER_COMPLETE`.
    *   **URL Prefixing & Bugs (28/11/2025, 00:25:40 - 07:47:14)**: Logic was added to ensure `checkoutUrl` was prefixed with `https://` if missing. This change introduced several temporary bugs due to incorrect variable initialization and conditional checks.
    *   **URL Prefixing Fix (28/11/2025, 07:48:18)**: The `checkoutUrl` prefixing logic was corrected to handle potential undefined values gracefully.
    *   **`orderKey` Handling Refinements (28/11/2025, 11:09:45 - 11:13:51)**: `orderKey` extraction was made more robust with optional chaining, and the condition for calling `SET_ORDER_COMPLETE` was loosened from requiring both `orderId` and `orderKey` to requiring either (`orderId || orderKey`).
    *   **Shift in Post-Order Flow (28/11/2025, 12:25:54 - 12:41:56)**:
        *   The logic for handling `orderSuccess` underwent another significant evolution. `orderKey` extraction was temporarily removed, and the component experimented with opening a generic "thank you" page URL using `OPEN_IN_WEBVIEW`.
        *   Initially, the explicit `SET_ORDER_COMPLETE` call was commented out (12:29:10), relying on the WebView navigation.
        *   Later, `SET_ORDER_COMPLETE` was re-enabled (12:40:35), suggesting a need to explicitly signal order completion to the host app even with WebView navigation.
        *   Finally, at 12:41:56, `orderKey` extraction was conditionally reintroduced, and the `OPEN_IN_WEBVIEW` action was made conditional (`if (!orderKey)`), implying it might be a fallback or an alternative navigation path.
    *   **Final Debugging (28/11/2025, 17:10:35 - 17:11:12)**: Additional console logs (`"Event Name and Data"`) were inserted for debugging the `onEvent` flow. The `checkoutUrl` prefixing and conditional `OPEN_IN_WEBVIEW` logic were simplified back to an earlier state, with consistent `orderKey` extraction and `SET_ORDER_COMPLETE` dispatch.

3.  **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/node_modules/@appmaker-packages/extension-kwikpass-expo-package/src/checkout/index.tsx` (27/11/2025, 18:54:00)**:
    *   This file acts as a simple wrapper, passing various `merchantParams` and event callbacks to the core `Checkout` component. No functional changes were observed in the provided logs.

4.  **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/node_modules/@appmaker-packages/extension-kwikpass-expo-package/src/checkout/Checkout.tsx` (27/11/2025, 18:57:26 - 20:35:26)**:
    *   This file defines the core `WebView` component. It injects JavaScript to intercept `gokwikSdk` events (`modal_closed`, `orderSuccess`, `openInBrowserTab`, etc.) and relay them back to React Native. It dynamically constructs WebView URLs, manages device and app state, handles errors, and includes specific logic for opening UPI payment apps (Google Pay, PhonePe, Bhim, Paytm) using Android intents. Despite multiple timestamps, the content provided for this file remained identical, suggesting no further functional changes were captured in these logs.

5.  **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/packages/kwikpassV2/src/pages/CheckoutOptions.js` (28/11/2025, 14:48:50)**:
    *   This file defines a React Native page configuration `CheckoutOptions` to embed the `kwikpass/checkout` block, indicating where the checkout functionality is presented in the application's UI. No functional changes were observed.

**Patterns and Recurring Elements:**

*   **GoKwik Checkout Focus**: The vast majority of changes relate to integrating and fine-tuning the GoKwik checkout process, particularly the `orderSuccess` event.
*   **Debugging**: Frequent addition and modification of `console.log` statements are a consistent pattern, indicating active and iterative debugging of the checkout flow, especially around critical data extraction and action dispatch.
*   **`orderSuccess` Event Handling Volatility**: The most dynamic part of the codebase is the `orderSuccess` event handling. This logic repeatedly changed how `orderID` and `orderKey` are derived, and whether the primary post-order action involves `SET_ORDER_COMPLETE` with a key, or navigating to a "thank you" page via `OPEN_IN_WEBVIEW`, or a combination of both.
*   **URL Handling**: Ensuring `checkoutUrl` is correctly formatted (e.g., prefixed with `https://`) and extracting relevant IDs/keys from complex URLs are recurring tasks.
*   **File Path Inconsistency**: The file `KwikPassCheckout.js` appears under both `/packages/` and `/src/` paths at different times, often with identical content, suggesting file renames, moves, or inconsistent project structure during development.