# Activity Summary for 28/11/2025

## 07:51:38
The changes primarily revolve around integrating and refining a GoKwik checkout experience within a React Native WebView for an Appmaker Expo application.

### File-Specific Updates:

*   **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/packages/kwikpassV2/src/components/KwikPassCheckout.js` (and later `src/kwikpassV2/src/components/KwikPassCheckout.js`)**
    *   **27/11/2025, 18:51:28**: Introduced the `KwikPassCheckout` component, which acts as a wrapper for the `KPCheckout` (GoKwik) WebView. This component sets up event listeners for GoKwik SDK events (`modal_closed`, `orderSuccess`, `openInBrowserTab`, `gk-checkout-disable`). The `orderSuccess` handler extracts Shopify order ID (`orderGID`) and a "key" from the `checkoutUrl` to trigger a `SET_ORDER_COMPLETE` action and conditionally performs `KWIKPASS_LOGIN`.
    *   **27/11/2025, 22:53:59**: Added `orderKeyRegexExtra` to allow for an alternative way of extracting the `orderKey` from `checkoutUrl`, making the extraction more robust. Debugging `console.log` statements were added around this time.
    *   **27/11/2025, 22:55:29 - 23:06:37**: A series of minor changes were logged, mainly involving the addition of numerous `console.log` statements to debug the order ID and key extraction logic within the `orderSuccess` event handler. A temporary issue where the `matches` variable was not explicitly declared or was missing its assignment appeared in some of these revisions, which could have led to runtime errors.
    *   **27/11/2025, 23:16:36**: This version correctly re-introduced the `matches` variable declaration, resolving the potential bug from earlier debugging efforts, and restored the `if (checkoutUrl && orderGID)` condition.
    *   **27/11/2025, 23:20:30**: The component's file path shifted from `packages/` to `src/`.
    *   **27/11/2025, 23:30:22**: A significant refactoring occurred within the `orderSuccess` handling. Instead of extracting order details and calling `SET_ORDER_COMPLETE`, the logic was changed to directly redirect the user to the `checkoutUrl` within a WebView using `OPEN_IN_WEBVIEW`. The `KWIKPASS_LOGIN` logic was also slightly clarified.
    *   **27/11/2025, 23:50:11**: The major refactoring from 23:30:22 was reverted. The component returned to its previous behavior of extracting `orderID`/`orderKey` and triggering `SET_ORDER_COMPLETE`.
    *   **28/11/2025, 00:25:40**: Logic was added to the `orderSuccess` handler to ensure `checkoutUrl` is always prefixed with `https://` if it lacks a protocol.
    *   **28/11/2025, 00:44:33 & 00:46:02**: A temporary bug was introduced in the `checkoutUrl` normalization, where initializing `checkoutUrl` to `null` before checking its protocol prevented the `https://` prefixing from occurring. The file path briefly reverted to `packages/` then back to `src/` during these changes.
    *   **28/11/2025, 07:47:14 & 07:48:18**: The `checkoutUrl` normalization bug was fixed, ensuring the URL is correctly processed to have an `https://` prefix.

*   **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/node_modules/@appmaker-packages/extension-kwikpass-expo-package/src/checkout/index.tsx` (27/11/2025, 18:54:00)**
    *   This file defines the `KPCheckout` React component, which serves as a memoized wrapper around the core `Checkout` component. It mainly passes through `checkoutData` and event handler props. The content remained stable.

*   **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/node_modules/@appmaker-packages/extension-kwikpass-expo-package/src/checkout/Checkout.tsx` (27/11/2025, 18:57:26 - 20:35:26)**
    *   This is the core WebView component responsible for displaying the GoKwik checkout. It includes:
        *   `injectJavaScript` for injecting event listeners (`modal_closed`, `orderSuccess`, `openInBrowserTab`, `gokwikLoaded`, `gk-checkout-disable`) directly into the WebView's JavaScript context, which then posts messages back to the native app.
        *   Logic to construct the WebView URL based on merchant type (Shopify or custom), fetching configurations from `CacheInstance` and encoding parameters with Base64.
        *   Handlers for native app events like hardware back presses and app state changes, which are relayed to the WebView.
        *   `UPI_APP_PACKAGES` and related logic (`convertToIntentUrl`, `handlePaymentIntent`) for deep linking to various UPI payment applications on Android.
    *   The content of this file remained consistent across all logged timestamps, indicating a stable and functional implementation during this period.

### Timestamps of Significant Changes:

*   **27/11/2025, 18:51:28**: Initial implementation of `KwikPassCheckout.js` with core GoKwik event handling.
*   **27/11/2025, 22:53:59**: Introduction of `orderKeyRegexExtra` for more robust order key extraction in `KwikPassCheckout.js`.
*   **27/11/2025, 23:16:36**: Crucial fix in `KwikPassCheckout.js` for the `matches` variable declaration, resolving a potential runtime error.
*   **27/11/2025, 23:20:30**: File relocation of `KwikPassCheckout.js` from `packages/` to `src/`.
*   **27/11/2025, 23:30:22**: Major functional refactor in `KwikPassCheckout.js` (`orderSuccess` now redirects to checkout URL instead of internal order completion).
*   **27/11/2025, 23:50:11**: Rollback of the 23:30:22 refactor in `KwikPassCheckout.js`.
*   **28/11/2025, 00:25:40**: Addition of `https://` URL normalization logic in `KwikPassCheckout.js`.
*   **28/11/2025, 00:44:33**: Introduction of a bug in `KwikPassCheckout.js` where `checkoutUrl` normalization was bypassed.
*   **28/11/2025, 07:47:14**: Correction of the `checkoutUrl` normalization bug in `KwikPassCheckout.js`.

### Patterns and Recurring Elements:

*   **GoKwik SDK Event-Driven Logic**: A consistent pattern across `KwikPassCheckout.js` and `Checkout.tsx` is the heavy reliance on processing events (`modal_closed`, `orderSuccess`, `openInBrowserTab`, `gk-checkout-disable`) originating from the GoKwik SDK within a WebView.
*   **Shopify Integration**: The code frequently handles Shopify-specific data, such as GraphQL Global IDs for carts and orders, and storefront access tokens.
*   **URL Parsing and Manipulation**: Regular expressions are extensively used to extract specific data (like order IDs and keys) from URLs. There's also a recurring concern about normalizing URLs to ensure they have the correct protocol (`https://`).
*   **Debugging Cycles**: The logs for `KwikPassCheckout.js` show a clear pattern of adding, modifying, and sometimes removing `console.log` statements, indicating active and iterative debugging during development, especially for the `orderSuccess` flow.
*   **File Path Fluctuation**: The `KwikPassCheckout.js` file path toggles between `packages/kwikpassV2/src/components/` and `src/kwikpassV2/src/components/` multiple times, suggesting possible refactoring, testing in different environments, or a migration in progress.
*   **Refactor and Revert**: A significant functional change in `KwikPassCheckout.js` (redirecting to checkout URL vs. internal order completion) was introduced and then reverted, highlighting an iterative development process or changes in implementation strategy.

## 08:51:02
The changes primarily revolve around implementing and refining a checkout flow using the `KwikPassCheckout` component within a React Native Expo application. This involves handling various events from a WebView, particularly for GoKwik SDK integration.

### File-Specific Updates:

*   **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/packages/kwikpassV2/src/components/KwikPassCheckout.js`** and **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/src/kwikpassV2/src/components/KwikPassCheckout.js`**:
    *   **Initial Change (27/11/2025, 18:51:28):** Introduced detailed event handling for `modal_closed`, `orderSuccess`, `openInBrowserTab`, and `gk-checkout-disable` events originating from the `gokwikSdk` within a WebView.
        *   For `orderSuccess`, it extracts `checkoutUrl`, `graphqlOrderId`, `gk_access_token`, and `email`. It attempts to parse Shopify order ID and key from these. It also includes logic to automatically log in the user via `KWIKPASS_LOGIN` if an email and `gkAccessToken` are present and the user isn't already logged in.
        *   `openInBrowserTab` handles opening URLs in a WebView or via custom URL schemes.
        *   `gk-checkout-disable` triggers an action to open the native Shopify checkout.
    *   **Minor Iterations (27/11/2025, 18:52:00 to 27/11/2025, 22:55:45):** These timestamps show repeated content, suggesting minor saves or reformatting without functional changes, possibly debugging or local testing.
    *   **Refinement in `orderSuccess` (27/11/2025, 22:53:59):** Added a `console.log` for "=== Matches for order key ===" within the `orderSuccess` handler, indicating an attempt to debug or verify the regex matching for `orderKey`.
    *   **Further Debugging and Consolidation (27/11/2025, 22:59:03 to 27/11/2025, 23:06:37):** Multiple updates focused on adding more `console.log` statements within the `orderSuccess` event handler, specifically around the extraction of `orderId` and `orderKey` from `checkoutUrl` and `orderGID`. This indicates active debugging of the order completion logic. The path `packages/kwikpassV2` and `src/kwikpassV2` alternate, potentially due to build or test environment configurations.
    *   **Significant Refinement to `orderSuccess` (27/11/2025, 23:16:36):** Introduced a new regex `orderKeyRegexExtra = /\/orders\/([^/?#]+)/` to more robustly extract the `orderKey` from `checkoutUrl`. The `matches` variable now attempts to match with either `orderKeyRegex` or `orderKeyRegexExtra`, enhancing flexibility for different URL formats.
    *   **Additional Logging in `orderSuccess` (27/11/2025, 23:16:45):** Added `console.log("ORDER KEY MATCHES", matches)` for debugging the newly added regex.
    *   **Major Structural Change in `orderSuccess` (27/11/2025, 23:30:22):** The `orderSuccess` case was significantly refactored.
        *   It now explicitly checks for the `orderSuccessBody`.
        *   The order ID extraction logic is clarified with comments, explicitly focusing on extracting from GraphQL GID.
        *   **Crucially, it changed the handling of `checkoutUrl`:** Instead of trying to extract an `orderKey` and rebuild a Shopify URL, it now directly redirects the user to the `checkoutUrl` provided by GoKwik using `OPEN_IN_WEBVIEW`. It explicitly states in comments that the `checkoutUrl` is *always* the correct redirect page and one should *not* manually extract keys or rebuild URLs.
        *   The auto-login logic using `KWIKPASS_LOGIN` is also clarified.
    *   **Reverted `orderSuccess` logic (27/11/2025, 23:50:11):** The logic for extracting `orderKey` using `orderKeyRegex` and `orderKeyRegexExtra` (which was removed in the previous major refactor) was reintroduced, suggesting a rollback or re-evaluation of the direct `checkoutUrl` redirection strategy.
    *   **Checkout URL Protocol Handling (28/11/2025, 00:25:40):** Added logic to prepend `https://` to `checkoutUrl` if it doesn't already start with `http://` or `https://`, ensuring valid URL formation for WebView.
    *   **Refined Checkout URL Protocol Handling (28/11/2025, 00:44:33 to 28/11/2025, 07:55:36):** The logic for prepending `https://` was slightly modified. The `checkoutUrl` variable was initially `null`, then assigned within the `if` block, leading to `checkoutUrl` potentially remaining `null` if it already started with `http(s)`. This was fixed in subsequent commits to correctly assign `checkoutUrl` from `message.data?.orderSuccessBody?.checkoutUrl` first and then check for and prepend `https://` if needed. The last few timestamps represent a stable version of this fix.

*   **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/node_modules/@appmaker-packages/extension-kwikpass-expo-package/src/checkout/index.tsx` (27/11/2025, 18:54:00):**
    *   This file exports the `KPCheckout` component, which acts as a wrapper for the `Checkout` component.
    *   The primary change visible is the addition of `orderTags` to the `Checkout` component's props, indicating that order tags can now be passed down to the underlying WebView. The `handleCheckoutMessage` callback ensures that `onEvent` prop is called with messages from the WebView.

*   **`/Users/mayuresh.madav/Documents/sdk/appmaker-starter-app-expo-53-update/node_modules/@appmaker-packages/extension-kwikpass-expo-package/src/checkout/Checkout.tsx` (27/11/2025, 18:57:26 to 27/11/2025, 20:35:26):**
    *   This file contains the core `WebView` implementation for the KwikPass checkout.
    *   **Key additions:**
        *   An `injectJavaScript` string is defined to listen for `gokwikSdk` events (`modal_closed`, `orderSuccess`, `openInBrowserTab`) and `gokwikLoaded`, `message`, and `gk-checkout-disable` events from the WebView, posting them back to the native React Native context via `window.ReactNativeWebView.postMessage`. This ensures communication between the web environment and the native app.
        *   A `UPI_APP_PACKAGES` object maps UPI app names to Android package IDs.
        *   `InitiateCheckout` function is enhanced to handle `custom` merchant types in addition to `shopify`, dynamically constructing the WebView URL based on merchant configuration, user data (email), and environment. It now uses `base64` encoding for `storeInfo` and `gkToken` when building Shopify checkout URLs.
        *   Logic for setting `orderTags` based on platform (iOS/Android) if not explicitly provided is added.
        *   `backButtonHandler` is implemented to manage WebView navigation history or post a "hardwareBackPress" message.
        *   `useEffect` hooks are used to set up and tear down listeners for hardware back presses and app state changes, ensuring the WebView receives these events.
        *   `showAlert`, `convertToIntentUrl`, and `handlePaymentIntent` functions are introduced to manage UPI payment intents, including error handling for "UPI_APP_NOT_INSTALLED" and converting URLs to Android intent URLs for specific UPI apps. This is a significant addition for handling native UPI flows.
        *   The `handleMessage` callback parses messages from the WebView and retrieves `merchantType` from `CacheInstance`.
    *   The multiple timestamps for this file (18:57:26, 18:59:47, 20:20:11, 20:35:26) show no discernible functional differences, suggesting minor saves or rebuilds.

### Patterns and Recurring Elements:

*   **GoKwik SDK Integration:** The primary focus across all relevant files is the integration with the `gokwikSdk`. Events like `modal_closed`, `orderSuccess`, `openInBrowserTab`, and `gk-checkout-disable` are consistently listened for and handled.
*   **WebView Communication:** There's a clear pattern of using `window.ReactNativeWebView.postMessage` in the injected JavaScript within `Checkout.tsx` to send events from the WebView back to the native `KwikPassCheckout.js` component, and `webViewRef.current.postMessage` to send events from native to the WebView.
*   **Shopify Integration:** The code frequently deals with Shopify-specific IDs (`gid://shopify/Shop/`, `gid://shopify/Cart/`, `gid://shopify/Order/`), storefront access tokens, and actions (`SET_ORDER_COMPLETE`, `KWIKPASS_LOGIN`, `OPEN_SHOPIFY_NATIVE_CHECKOUT`).
*   **URL Handling:** Extensive logic is dedicated to parsing, validating, and sometimes modifying URLs, particularly for `orderSuccess` (extracting order details) and `openInBrowserTab` (determining how to open external links). A recurring task is to ensure `checkoutUrl` has a proper protocol (`https://`).
*   **Debugging/Logging:** Frequent `console.log` statements throughout the code, especially in the `KwikPassCheckout.js` file, indicate active development and debugging during these changes.
*   **User Authentication:** The `orderSuccess` event consistently includes logic to check if a user is logged in and, if not, to perform a `KWIKPASS_LOGIN` using details from the GoKwik SDK response.
*   **Timestamps:** All significant changes occurred on **27/11/2025** and **28/11/2025**, indicating a concentrated period of development and refinement. The numerous changes within minutes suggest rapid iterations, likely during active testing or debugging sessions.