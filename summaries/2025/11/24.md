# Activity Summary for 24/11/2025

## 10:34:18
The provided log details changes to a single file: `/Users/mayuresh.madav/Documents/dashboard/dashboard-ui-utilities/src/services/common.ts`. This file appears to contain utility functions for making API calls (`makeAPICall`) and logging user events (`logUserEvent`).

**File-specific Updates:**

*   **`/Users/mayuresh.madav/Documents/dashboard/dashboard-ui-utilities/src/services/common.ts`**:
    *   **Initial State (22/11/2025, 17:38:55)**: The `makeAPICall` function includes error handling for `401` (Unauthorized) status codes. Upon receiving a `401`, it navigates to the `/login` page after clearing the `localStorage` token, and returns `{ ...error, error: true }`. The file also defines an `EventsInterface` and the `logUserEvent` function, which captures user and merchant details, generates a session ID, and parses user agent strings.
    *   **First Change (22/11/2025, 17:39:07)**: A modification was made within the `makeAPICall` function's `catch` block for `401` errors. The error return statement was changed from `{ ...error, error: true }` to `{ error: true, message: error?.response?.data?.message || error.message }`. This suggests an intent to provide a more specific error message to the caller.
    *   **Second Change (22/11/2025, 17:39:40)**: This entry shows a reversion of the previous change. The error return statement for `401` errors in `makeAPICall` was changed back to its original form: `{ ...error, error: true }`.

**Timestamps of Significant Changes:**

*   **22/11/2025, 17:39:07**: A focused update to the `makeAPICall` function's error handling for 401 responses.
*   **22/11/2025, 17:39:40**: A rapid subsequent change, reverting the modification made just 33 seconds prior.

**Patterns or Recurring Elements in the Content:**

*   **API Call Management**: The file consistently features the `makeAPICall` function, which handles various aspects of API requests, including loader management, user role-based restrictions, dynamic headers (e.g., `merchant-mid`), cookie handling, and specific logic for single and multiple file uploads.
*   **Security Headers**: The Axios instance within `makeAPICall` consistently sets several security-related HTTP headers like `X-Content-Type-Options`, `Referrer-Policy`, `X-XSS-Protection`, and `Content-Security-Policy`.
*   **Unauthorized Error Handling (401)**: A core pattern is the specific handling of `401` HTTP responses, which involves clearing the user's token, redirecting to the login page (with path preservation), and returning an error object. The rapid changes within this specific block indicate an iterative or reconsidered approach to how 401 errors are reported back.
*   **User Event Logging**: The `logUserEvent` function is consistently present, demonstrating a structured approach to capturing user interactions, session information, merchant data, and parsing user agent details to understand the operating system, device, and browser.
*   **Dashboard-specific Utilities**: Imports like `dashboardStore` and `navigateToUrl` suggest that these utilities are part of a larger dashboard application environment, likely a micro-frontend setup due to `single-spa`.
*   **Short Iterations**: The timestamps show very quick, almost immediate, changes and reversions, particularly for the `makeAPICall` function's error handling. This could indicate active debugging, rapid testing, or a quick decision to revert a recent change.

## 10:34:51
The provided log details code changes across various UI components and configuration files, primarily within the `checkout-dashboard-ui` and `dashboard-ui-configuration` projects. The changes span from November 16, 2025, to November 21, 2025.

### File-Specific Updates:

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/pages/settings/customizeUI/brandPage.tsx` (Timestamp: 16/11/2025, 13:10:34)**
    *   This file, representing a "Brand Page" for UI customization, was significantly updated.
    *   It now includes functionality for uploading a brand logo, handling image clean-up, obtaining presigned AWS URLs for uploads, and displaying a logo preview.
    *   The component uses `Form` and `Upload` from `gokwik-ui-kit`, `useEffect` for data fetching and form updates, and integrates `makeAPICall`, `makeAWSPutCall`, `cleanImageWithCanvas`, and `getBase64` utilities.
    *   It allows customization of the primary color via a `ColorPicketComponent` and manages saving brand configuration via `useMerchantConfigApi`.
    *   A new `InfoComponent` was added for descriptive text and a link to a Confluence page.
    *   The "Save Changes" button is disabled until form values change (`isVisible` state).

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/library/components/discounts/productSearch.tsx` (Timestamp: 17/11/2025, 16:22:51 and 21/11/2025, 11:48:56)**
    *   This component facilitates searching and selecting products or collections for discount rules.
    *   **17/11/2025, 16:22:51**: The component was updated to handle product and collection searching from Shopify. It includes pagination via `useIntersectionObserver`, debounced search input, and logic for collating product variants. It also supports quantity management for collections and special handling for "agent-led" items (filtering out `no-agent` tagged products). A `topUpGift` prop was added to allow setting an `offered_price`.
    *   **21/11/2025, 11:48:56**: Minor updates were made, primarily adding a `DeleteOutlined` icon import and a `btnSearch` prop. The display logic for `variants selected` and `quantity` was refined for collated products. The `handleQuantityChange` function was also adjusted to pass `quantity` only if `collectionMinimumPurchangeQuantity` is enabled.

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/pages/orders/order-details/index.tsx` (Timestamp: 17/11/2025, 16:23:04)**
    *   This file focuses on displaying order details.
    *   Key updates include a custom `formatAmountWithCurrency` function to ensure correct currency symbol display, separate from the `formatAmount` utility.
    *   A `statusMappingForColors` and `statusMappingForTag` were introduced for visual representation of order statuses.
    *   A `mergeRepeatedRefunds` utility function was added to aggregate multiple refund attempts for a single `gokwik_rid` into a `MergedRepeatedRefund` object.
    *   The `fetchOrderDetails` logic was enhanced to determine and set `totalRefundAbleAmount` and `refundBtnState`, considering various transaction statuses and auto-refunds. It also now sets the global `currentCurrencySymbol` based on order data or merchant details.
    *   Price breakup calculations were expanded to include various discount types, taxes, shipping, and gift/reward amounts.
    *   Logic for displaying `order_failure_reason` and handling "fake order reasons" was added, along with conditional disabling of the "Edit Order" button based on applied rewards, GWP discounts, or loyalty points.

*   **`/Users/mayuresh.madav/Documents/dashboard/dashboard-ui-configuration/src/index.ejs` (Timestamp: 18/11/2025, 00:45:31, 20/11/2025, 18:37:48, and 21/11/2025, 12:27:47)**
    *   This EJS template is responsible for configuring the single-spa application's import maps for different deployment environments (local, dev, qa, sandbox, production).
    *   **18/11/2025, 00:45:31**: The `sandbox` configuration was uncommented, explicitly setting `REACT_APP_BASE_URL` and `REACT_APP_BULK_DISCOUNT_URL` to sandbox endpoints.
    *   **20/11/2025, 18:37:48**: The `qa` environment configuration was uncommented, activating the `qa` endpoints for base and bulk discount URLs. The `sandbox` environment was commented out. For `isLocal`, the `utilities`, `dashboard`, `payment`, `kwikpass`, `rto`, `kwikship`, `ellora`, `checkout-platform`, and `shopify-app` imports were updated to point to `qa-dashboard.dev.gokwik.in` instead of `sandbox-dashboard.dev.gokwik.in` for some, while `@gokwik/checkout` remained `//localhost:9002`.
    *   **21/11/2025, 12:27:47**: The `sandbox` configuration was re-enabled, while `qa` was commented out. The `isLocal` environment reverted to using `sandbox-dashboard.dev.gokwik.in` for the majority of `@gokwik` module imports, aligning with the `sandbox` environment. This shows a back-and-forth toggling between `qa` and `sandbox` environments for local development and base URL configurations.

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/pages/settings/free-gift/freeGift.tsx` (Timestamp: 18/11/2025, 00:49:40, 18/11/2025, 00:50:14, and 18/11/2025, 00:58:39)**
    *   This component manages "Free Gift Settings." The content across these three timestamps is identical, indicating no functional changes were introduced during this period, but possibly multiple saves or rebuilds.
    *   It uses `ProductSearch` for selecting products/collections for free gifts and `useMerchantConfigApi` to manage rules.
    *   The form includes various fields for defining free gift rules (name, sales channels, purchase type, min/max value, applicable products/collections, free gift quantity/price, application method, selection limit).
    *   It renders a table to display existing free gift rules with options to enable/disable, edit, or delete them.
    *   The `handleEdit` function adjusts `sales_channels` if the application method is not 'auto'.
    *   The `handleAddFreeGiftProduct` and `handleAddApplicableOnItems` functions manage the selected products/collections, preventing duplicate entries.

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/library/components/orderConfirmationPage/collapseFields.tsx` (Timestamp: 18/11/2025, 23:42:52)**
    *   This component provides collapsible sections for customizing the order confirmation UI.
    *   It defines fields for "Order Details," "Customer Information," and "Support & Communication," each with switches to enable/disable sections, input fields for text, and `ColorPickerHelper` for background and text colors.
    *   It incorporates `LogoPage`, `RenderEditorFunction` (for dynamic banners), and `TrustBadgeForm` components.
    *   The entire collapse structure is made draggable, allowing users to reorder the sections by drag-and-drop, which updates the form's `customize` field value.

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/pages/settings/orderConfirmation/index.tsx` (Timestamp: 19/11/2025, 21:10:01, 19/11/2025, 21:11:54, 19/11/2025, 21:12:22, and 19/11/2025, 21:12:29)**
    *   This page manages settings for the Order Confirmation Page, including a preview.
    *   **19/11/2025, 21:10:01**: Initial layout for the order confirmation page settings, with sections for enabling the custom page and including `MainSection` and `OrderConfirmationPreview` components. It includes a `handleFormSubmit` function that validates fields while excluding specific "trust banner data" fields. The main content column `flex` property is `1 1 200px` and the preview column `flex` is `0 1 500px`.
    *   **19/11/2025, 21:11:54**: The `flex` properties for the main content column and preview column were adjusted to `1 1 300px` and `0 1 300px` respectively, likely to balance the layout.
    *   **19/11/2025, 21:12:22**: The `flex` properties were reverted to the initial `1 1 200px` for the main content and `0 1 500px` for the preview.
    *   **19/11/2025, 21:12:29**: The `flex` properties were again adjusted to `1 1 300px` for the main content and `0 1 500px` for the preview, indicating an iterative refinement of the UI layout. The functionality remained consistent across these changes.

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/library/components/shipping/shippingBasedData.tsx` (Timestamp: 20/11/2025, 18:44:34, 20/11/2025, 18:44:55, 20/11/2025, 18:49:44, and 20/11/2025, 18:49:50)**
    *   This component manages product-based shipping rules.
    *   **20/11/2025, 18:44:34**: The `Rule price` input field was set to `type: 'inputNumber'`. Logic to prevent adding duplicate product variants or collections was implemented in `onAdd` handlers for `ProductSearch`.
    *   **20/11/2025, 18:44:55**: The `Rule price` input field's `type` was changed back to `input`, but `inputProps` retained `type: 'number'`, and no `onKeyPress` validation was added yet.
    *   **20/11/2025, 18:49:44**: The `Rule price` input field (`type: 'input'`) was updated to include an `onKeyPress` event handler in its `inputProps` to restrict input to only numbers and periods, ensuring valid price format.
    *   **20/11/2025, 18:49:50**: No functional changes, similar to the `freeGift.tsx` entries, suggesting a save or formatting operation.

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/library/utilities/helpers/helper.ts` (Timestamp: 21/11/2025, 11:50:18 and 21/11/2025, 11:51:40)**
    *   This file contains various utility helper functions. The content across these two timestamps is identical, indicating no functional changes were introduced.
    *   It defines helpers for dynamic search filters, date formatting, currency formatting (`setCurrencySymbol`, `formatAmount`), checking Shopify app checkout status, deep object comparison (`deepCompare`), debouncing, disabling dates/times, capitalizing strings, number formatting, extracting table column titles/data indexes, sorting data, uploading CSVs for cohorts (with phone/email validation), getting future dates, comparing array fields, and validating date ranges.

### Timestamps of Significant Changes:

*   **16/11/2025, 13:10:34**: Major feature implementation for Brand Page UI customization, including logo upload and color picking.
*   **17/11/2025, 16:22:51**: Significant update to `ProductSearch` component, adding advanced search features, variant collation, and specific item handling.
*   **17/11/2025, 16:23:04**: Extensive updates to Order Details page, focusing on currency formatting, refund logic, status mapping, and dynamic content based on order data.
*   **18/11/2025, 23:42:52**: Introduction of draggable and customizable sections for the order confirmation page.
*   **19/11/2025, 21:10:01 - 21:12:29**: Iterative layout adjustments for the Order Confirmation Page, focusing on column `flex` properties.
*   **20/11/2025, 18:44:34 - 18:49:44**: Refinements in `shippingBasedData.tsx`, particularly regarding `Rule price` input type and validation, and adding duplicate item prevention in `ProductSearch` handlers.
*   **20/11/2025, 18:37:48 & 21/11/2025, 12:27:47**: Frequent toggling of base URLs and module imports between `qa` and `sandbox` environments in `index.ejs`, reflecting environment switching or testing.

### Patterns or Recurring Elements:

*   **`gokwik-ui-kit` Usage**: Many components heavily rely on `gokwik-ui-kit` for UI elements like `Button`, `Form`, `Card`, `Input`, `Table`, `Switch`, `Dropdown`, `message`, `Tooltip`, etc., indicating a standardized UI library across the dashboard.
*   **Form Management with Ant Design (Form.useForm(), Form.useWatch(), Form.setFieldValue())**: All UI components dealing with settings or input forms leverage Ant Design's `Form` API for state management, validation, and data binding.
*   **`useMerchantConfigApi` Hook**: This custom hook (`@library/utilities/hooks/useMerchantConfig`) is consistently used across settings pages (`BrandPage`, `FreeGift`) to fetch and save merchant-specific configurations, suggesting a centralized mechanism for managing dynamic settings.
*   **`makeAPICall` and `makeAWSPutCall`**: These utility functions (`@gokwik/utilities`) are frequently used for interacting with backend APIs and AWS services (e.g., logo uploads), indicating a standard approach for network requests.
*   **Breadcrumbs (`updateBreadcrumbs`)**: The `updateBreadcrumbs` utility is called in `useEffect` hooks in multiple pages (`BrandPage`, `FreeGift`) to maintain navigation context within the application.
*   **Environment Configuration (index.ejs and .env)**: There's a clear pattern of managing API base URLs and module imports for different deployment environments (`dev`, `qa`, `sandbox`, `production`) using conditional logic in `index.ejs` and `.env` files. The frequent changes in `index.ejs` specifically show a recurring task of switching or testing different deployment environments.
*   **Placeholder Images**: `ShopifyProductPlaceholderImage` and `ShopifyCollectionPlaceholderImage` are used consistently to display default images when actual product/collection images are not available, improving UI robustness.
*   **Currency Formatting**: The `setCurrencySymbol` and `formatAmount` utilities are used to ensure consistent currency display, with `formatAmountWithCurrency` providing a more explicit localized formatting when needed.
*   **Input Validation**: Forms often include `rules` for required fields and custom validators (e.g., `max_value` validation, CSV content validation), demonstrating attention to data integrity.

## 11:34:19
The file `/Users/mayuresh.madav/Documents/dashboard/dashboard-ui-utilities/src/services/common.ts` serves as a core utility for handling API calls and logging user events within the dashboard UI.

**File-Specific Updates:**

*   **`makeAPICall` Function:** This asynchronous function is responsible for making API requests using Axios, supporting various HTTP methods, file uploads (single and multiple), and dynamic configuration.
    *   It implements robust security headers like `X-Content-Type-Options`, `Referrer-Policy`, `X-XSS-Protection`, and `Content-Security-Policy`.
    *   It restricts 'internal users' from performing non-'get' operations on a predefined list of URLs.
    *   It manages loading states using `loaderEvent` and handles specific error cases, notably unauthorized (401) responses.
    *   For 401 errors, it clears the local storage token, saves the current path for redirection, and navigates to the `/login` page under certain conditions, ensuring session management.
*   **`logUserEvent` Function:** This function is designed to log detailed user events.
    *   It collects extensive user-specific and context-specific data, including `tracking_id`, `request_id`, `email`, `session_id` (generated using `nanoid` and stored in cookies if not present), `merchant_id`, `merchant_name`, `username`, `role`, and `timestamp`.
    *   It dynamically determines the `landing_page` based on the current window location.
    *   It includes a `parseUserAgent` helper function to extract operating system, device, OS version, browser, browser version, and webview status from the `navigator.userAgent` string.

**Timestamps of Significant Changes:**

*   **22/11/2025, 17:38:55**: The `makeAPICall` function's error handling for 401 status codes initially returned `{ ...error, error: true }` after performing token removal and navigation.
*   **22/11/2025, 17:39:07**: A change was introduced to the `makeAPICall` function's 401 error handling. The return statement was modified from `{ ...error, error: true }` to `{ error: true, message: error?.response?.data?.message || error.message }`, aiming to provide a more specific error message from the API response.
*   **22/11/2025, 17:39:40**: The change made at 17:39:07 was reverted. The 401 error handling in `makeAPICall` was restored to its original state, returning `{ ...error, error: true }`.

**Patterns or Recurring Elements:**

*   **Centralized API Communication:** The `makeAPICall` function acts as a single point of entry for all API interactions, ensuring consistent headers, error handling, and loading state management across the application.
*   **User and Merchant Context:** Both `makeAPICall` and `logUserEvent` frequently access `dashboardStore.getState().userData.user_details` and `dashboardStore.getState().userData.merchant_details` to retrieve user and merchant-specific data, indicating a strong reliance on a global state management system.
*   **Environment-Specific Configuration:** The use of `process.env.REACT_APP_BASE_URL` and conditional security headers based on `process.env.NODE_ENV !== 'development'` highlights the application's adaptability to different deployment environments.
*   **Session and Cookie Management:** The functions utilize `localStorage`, `sessionStorage`, and custom cookie utilities (`getCookie`, `setCookie`) for managing user tokens, merchant IDs, redirection paths, and session IDs.
*   **Rapid Iteration and Reversion:** The sequence of changes to the 401 error handling in `makeAPICall` (changed and then immediately reverted within a minute) suggests a quick experimentation or a rollback of a recently introduced code change.
*   **Detailed Event Logging:** The `logUserEvent` function demonstrates a comprehensive approach to collecting user behavior and device information, crucial for analytics and debugging.