# Activity Summary for 19/11/2025

## 11:53:15
The provided log details changes across multiple files in a dashboard UI, focusing on customization, order management, and discounts.

### File-Specific Updates:

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/pages/settings/customizeUI/brandPage.tsx`** (Timestamp: 16/11/2025, 13:10:34)
    *   This file, responsible for the brand customization page, received updates related to logo upload functionality and theme color management.
    *   It includes logic for validating image files (type, size), handling uploads to AWS S3, and fetching pre-signed URLs.
    *   The form (`Form.useForm()`) manages `brand_data`, including `logo`, `logoImg`, and `cssRules.primaryColor`.
    *   `useEffect` hooks are used to initialize logo data from `merchant_details` and update primary color from `config.custom_config`.
    *   The component renders UI for uploading a logo, displaying a preview, and a color picker for the primary theme color.
    *   Saving changes (`onFinish`) involves updating the merchant logo via API and saving configuration.

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/library/components/discounts/productSearch.tsx`** (Timestamp: 17/11/2025, 16:22:51)
    *   This component manages product and collection search functionality for discounts.
    *   It was updated to support collating products (grouping variants under a single product), handling quantities for collections, and filtering products based on tags for 'agent-led' scenarios.
    *   The `parseResponse` function was modified to correctly group product variants when `collateProducts` is true and to handle filtering for `isAgentLed` items.
    *   New props like `collateProducts`, `showQuantity`, `alloweditemscount`, `hideSearchInput`, `isAgentLed`, `topUpGift`, and `collectionSpecificData` were introduced.
    *   Logic for incrementing/decrementing item quantities and handling gift prices was added.
    *   The UI renders search input, a modal for search results with checkboxes for selection, and displays selected products/collections with their details and quantity controls.

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/pages/orders/order-details/index.tsx`** (Timestamp: 17/11/2025, 16:23:04)
    *   This file, for displaying order details, received significant updates to its data processing and display logic.
    *   New helper functions `formatCurrency` and `formatAmountWithCurrency` were introduced for improved currency formatting.
    *   A `mergeRepeatedRefunds` function was added to aggregate multiple refund attempts for a single `gokwik_rid` and determine the final status (`Completed`, `Failed`, `Initiated`).
    *   The `fetchOrderDetails` function now handles various price breakup components (discounts, taxes, shipping, gift cards, rewards, store credits) and calculates the total refundable amount, setting the state for the refund button.
    *   It includes logic to set an `editTitle` and `disableEdit` state based on applied rewards, GWP discounts, or loyalty points.
    *   Improved handling for `is_deleted` and `is_auto_refund` flags for transactions.
    *   Introduced `order_failure_reason` and `showRTOActions` logic.
    *   The component leverages `useMemo` for `discountBreakup` calculation to optimize performance.

*   **`/Users/mayuresh.madav/Documents/dashboard/dashboard-ui-configuration/src/index.ejs`** (Timestamp: 18/11/2025, 00:45:31)
    *   This EJS template defines the structure of the dashboard UI.
    *   It includes a Content Security Policy (CSP) for security.
    *   The primary change involves updating the `systemjs-importmap` configurations for various environments (`local`, `dev`, `qa`, `sandbox`, `production`).
    *   Specific Micro-frontend applications (e.g., `@gokwik/configuration`, `@gokwik/utilities`, `@gokwik/dashboard`, `@gokwik/checkout`, `@gokwik/payment`, `@gokwik/kwikpass`, `@gokwik/rto`, `@gokwik/kwikship`, `@gokwik/ellora`, `@gokwik/checkout-platform`, `@gokwik/shopify-app`, `@gokwik/kwikcomm`) now point to their respective deployment URLs based on the `deployedEnv` variable.
    *   New Relic and Clarity analytics scripts are conditionally included for the `production` environment.

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/pages/settings/free-gift/freeGift.tsx`** (Timestamp: 18/11/2025, 00:49:40, 18/11/2025, 00:50:14, 18/11/2025, 00:58:39)
    *   These three entries show identical code changes, indicating repeated saves or minor, non-substantive changes in quick succession.
    *   This file manages the Free Gift settings.
    *   It defines a `FreeGift` component with state for rules, editing, and changes.
    *   The `useMerchantConfigApi` hook is used for fetching and saving configuration.
    *   It uses `Form.useWatch` to react to changes in free gift configuration, specific products/collections, free product, application method, and applicable on settings.
    *   An `initialValues` object defines the default configuration for auto gift rules.
    *   `useEffect` is used to update breadcrumbs for navigation.
    *   The `fields` array defines the structure and validation rules for a dynamic form, including input, checkbox, radio, inputNumber, and search types, with conditional visibility (`hideControlInput`, `hidden`) based on other form values.
    *   The `columns` array defines the structure for a table to display free gift rules, including name, free gift product (with image), status (toggle switch), and actions (edit/delete dropdown).
    *   `handleEdit`, `handleDelete`, `handleAddFreeGiftProduct`, and `handleRemoveFreeGiftProduct` functions manage the state of free gift rules and their associated products.

*   **`/Users/mayuresh.madav/Documents/dashboard/checkout-dashboard-ui/src/library/components/orderConfirmationPage/collapseFields.tsx`** (Timestamp: 18/11/2025, 23:42:52)
    *   This component organizes various UI customization fields for the order confirmation page into collapsible sections.
    *   It uses `Form.useWatch` to react to changes in `customize` data.
    *   The component defines separate field configurations (`orderDetailFields`, `customerInformationFields`, `supportDetailFields`) for different sections of the order confirmation page, including switches for enabling/disabling sections, input fields for text, and `ColorPickerHelper` for background and text colors.
    *   The `items` array structures these sections into a `Collapse` component, allowing each section to be toggled, with an additional switch in the `extra` prop for enabling/disabling the entire section.
    *   It integrates other components like `LogoPage`, `RenderEditorFunction` (for dynamic banners), and `TrustBadgeForm`.
    *   Introduces drag-and-drop functionality for reordering collapse items, allowing users to customize the layout of the order confirmation page fields.

### Timestamps of Significant Changes:

*   **16/11/2025, 13:10:34**: Significant updates to brand customization, particularly logo upload and theme color.
*   **17/11/2025, 16:22:51**: Major enhancements to product/collection search, including product collation, quantity management, and filtering.
*   **17/11/2025, 16:23:04**: Substantial changes to order details display, refund logic, and currency formatting.
*   **18/11/2025, 00:45:31**: Core infrastructure update with environment-specific import map configurations and analytics scripts in `index.ejs`.
*   **18/11/2025, 23:42:52**: Introduction of drag-and-drop and extensive customization options for the order confirmation page.

### Patterns or Recurring Elements:

*   **`useMerchantConfigApi` Hook**: Frequently used across `BrandPage` and `FreeGift` components for fetching, updating, and saving merchant-specific configurations, indicating a centralized configuration management system.
*   **Form Management with Ant Design (Gokwik-UI-Kit)**: Extensive use of `Form.useForm()`, `Form.Item`, `Form.useWatch`, and `form.setFieldsValue()` for managing form state, validation, and interaction, particularly in `BrandPage`, `FreeGift`, and `collapseFields`.
*   **Dynamic UI Rendering with `RenderField`**: The `RenderField` utility component is used to dynamically render various form input types based on a configuration array (e.g., in `FreeGift` and `collapseFields`), promoting reusability and declarative UI construction.
*   **Customization and Configuration**: A strong theme of enabling merchants to customize various aspects of the checkout UI (brand logo, theme color, order confirmation page sections, free gift rules).
*   **API Interactions**: Frequent use of `makeAPICall` and `makeAWSPutCall` for backend communication (e.g., fetching order details, uploading images, saving configurations).
*   **Breadcrumb Navigation**: `updateBreadcrumbs` utility is used in `FreeGift` to manage consistent navigation paths across the application.
*   **Date Formatting and Currency Handling**: Specific helper functions (e.g., `formatAmount`, `setCurrencySymbol`, newly added `formatCurrency` and `formatAmountWithCurrency`) are used to ensure consistent display of numerical and monetary values.
*   **Timestamp Proximity**: The three identical `freeGift.tsx` entries on 18/11/2025 suggest either rapid iteration, minor non-functional changes, or repeated saves without actual code differences being logged.
*   **Environment-Specific Deployments**: The `index.ejs` file clearly demonstrates a pattern of setting up different Micro-frontend module URLs based on the deployment environment (`local`, `dev`, `qa`, `sandbox`, `production`), highlighting a robust CI/CD and deployment strategy.
*   **New Relic Integration**: The `index.ejs` also shows a pattern of integrating New Relic monitoring for performance and error tracking, specifically in the production environment.

## 12:00:41
The provided log details changes across several files, primarily focusing on checkout, payment, and analytics functionalities within a SvelteKit application.

### File-Specific Updates:

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/common/services/ShippingDiscount.service.ts`**
    *   **Timestamp:** Consistent updates on `12/11/2025, 21:20:24` and `15/11/2025, 12:00:15`.
    *   **Updates:** This service is heavily involved in managing discounts and shipping options.
        *   Numerous Svelte stores are subscribed to, indicating a highly reactive and state-driven component.
        *   The `callShippingDiscountApi` function handles discount application, removal, and combination calls. It includes logic for clearing API timers, displaying confetti for successful discounts (conditional on user type and redirection flow), and handling Gyftr rewards.
        *   Error handling for invalid discount channels is present.
        *   `processShippingDiscountResponse` further processes API responses, updating shipping methods, discounts, and handling gift card reapplication on cart updates.
        *   Specific fixes for issues like `CHECKOUT-15842` (GiftCard on Cart Update) and `CHECKOUT-12982` (Payment Methods on Shipping Options) are noted.
        *   New logic for UTM auto-apply discount/shipping options failure is added, which prevents displaying an error message on the UI in such cases.
        *   Introduces logic for `discount_shipping_retry` based on available shipping options.

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/common/services/EnvironmentService.ts`**
    *   **Timestamps:** Multiple updates between `13/11/2025, 14:31:15` and `17/11/2025, 23:34:43`.
    *   **Updates:** This file defines base URLs for various services (health, address suggestion, core API, experiments, TwidPay, analytics) based on the environment (dev, qa, sandbox, production, local).
        *   Consistently updates the `api_url` for the `local` environment, switching between different development/production endpoints, indicating active testing and environment configuration changes.
        *   The `XGokwikToken` and `XKWIKPASSToken` functions dynamically return session tokens based on the environment.

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/public/merchant.html`**
    *   **Timestamps:** Multiple updates between `13/11/2025, 14:31:36` and `17/11/2025, 23:35:35`, and then more on `18/11/2025` around `14:50:00`.
    *   **Updates:** This is a merchant integration HTML file.
        *   The `gokwikSdk` is defined to manage checkout initiation, event handling (`on`, `emit`), and UI interactions like hiding buttons.
        *   Initial script loading (`gokwik.js`) and event listeners (`DOMContentLoaded`, `initGKJS`) are present.
        *   Cookie management (`getCookieGk`, `setCookieGk`) for tracking landing page and referrer is included.
        *   The `window.merchantInfo` object, crucial for merchant-specific configurations like `mid`, `environment`, `storeId`, and `fbpixel`, is frequently updated (different `mid` values are commented out, suggesting testing across multiple merchant IDs).
        *   The `initKwikCheckout` function (in `kwik-checkout.html` variant) loads integration and analytics scripts dynamically.
        *   Listeners for `checkoutHealth` and `shopifyRedirect` are present, which trigger a custom event `gk-checkout-disable` for fallback.
        *   Recent changes in `kwik-checkout.html` (18/11/2025) include adding `window.__KP_EMAIL__ = kpEmail;` which suggests handling Kwikpass email information more directly in the global scope.

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/Components/place-order/PaymentOptions.svelte`**
    *   **Timestamps:** Frequent updates on `13/11/2025` (multiple times around `20:56:52` to `21:25:07`) and `15/11/2025, 12:01:15`.
    *   **Updates:** This Svelte component is central to payment options display and logic.
        *   Imports a vast array of Svelte stores from `CommonStore` and `OrderStore`, highlighting a highly interconnected and stateful component.
        *   Manages various payment-related states: `totalPrice`, `screen_width`, `codPaymentFailed`, `availableAutoOffers`, `recommendedOptions`.
        *   Initializes tracking events on mount (`payment_step_landed`, `AddPaymentInfo`).
        *   Includes logic for applying recommended TwidPay rewards, fetching Shopify credits, and handling COD confirmation.
        *   Filters and reorders `availableAutoOffers` based on payment methods and screen width.
        *   Introduces `store_availableOffersCheck`, `store_isLoggedInUser`, `store_isCartUpdated` in the latest version (15/11/2025), indicating more granular control over offer display and user state.
        *   Adds `AutomaticGiftHeader` and `GiftJourney` components in the latest update, suggesting new features for free gift management.

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/Components/place-order/OrderSummary.svelte`**
    *   **Timestamps:** Consistent updates on `15/11/2025, 11:49:48` and `15/11/2025, 11:52:44`.
    *   **Updates:** This component manages the order summary display.
        *   Calculates `totalPrice` based on `subTotal`, various discounts (coupon, prepaid, partner acquisition, gift card, loyalty, Gyftr), shipping, and COD charges.
        *   Handles logic for displaying automatic discounts and segregating free products (BXGY offers).
        *   Includes subscriptions to numerous stores (`cartjsObject`, `discountAmount`, `prepaidDiscount`, `codCharges`, `selectedShippingMethod`, `giftCardTotal`, etc.) to reactively update the summary.
        *   Introduces `lineItemEdds` and `earnedLoyaltyDetails` to influence loyalty display amount calculations.

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/merchant/Analytics/Contlo.ts`**
    *   **Timestamps:** Multiple updates between `17/11/2025, 13:05:00` and `17/11/2025, 14:14:00`.
    *   **Updates:** This file integrates with Contlo analytics.
        *   Initially, it defined a dummy `window.contlo` object, but subsequent updates remove this, implying the actual Contlo SDK is expected to be present.
        *   Consolidates `createBody` function to prepare data for Contlo events, including product IDs, promo code, cart total, and UTM marketing data.
        *   Defines functions (`contloMobile`, `contloPincode`, `contloPaymentMethod`, `contloPaymentCompleted`, `contloAddressAdded`, `contloDiscountEvent`) to call `contloSendEvent` with specific event names and data.
        *   A key change in the `createBody` function (17/11/2025, 14:07:01) is to ensure `cart_total_price` is a valid number by checking `!isNaN(Number(commonAnalyticsData?.cart_after_discount))`. This is further refined to check for `!!commonAnalyticsData?.cart_after_discount` (17/11/2025, 14:13:04), indicating a robustness improvement for handling `cart_after_discount` values.
        *   `contloSendEvent` is wrapped in a try-catch block, logging an error if `window.contlo.sendEvent` is not found, suggesting more robust error handling for external SDKs.

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/common/services/ForeignAnalytics.ts`**
    *   **Timestamps:** Multiple updates between `17/11/2025, 12:56:56` and `17/11/2025, 14:05:25`.
    *   **Updates:** This service is responsible for integrating various third-party analytics platforms.
        *   Imports and subscribes to a vast number of Svelte stores related to user data, cart information, discounts, and merchant configurations.
        *   Maintains a `priceBreakup` object to aggregate financial details for analytics.
        *   Manages `fbPixelEventsAndKeys` for Facebook pixel custom events.
        *   Dynamically builds `configObject` based on `store_foreignAnalytics` to enable/disable different analytics pixels.
        *   Includes logic to integrate `kwikOptimizerPixelIds` with Facebook custom events.
        *   The `generateTrackingData` function is called reactively when `cartjsObject` or `totalPrice` updates.
        *   A `console.log(res)` was added to the `store_totalPrice` subscription on 17/11/2025, 13:55:47, likely for debugging purposes, and then removed in the next commit.

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/Components/common/Promotion.svelte`**
    *   **Timestamp:** `17/11/2025, 22:38:42`.
    *   **Updates:** Displays promotional text related to loyalty points, store credits, and gift cards.
        *   Dynamically constructs `redeemableText` based on the availability and enablement of loyalty, credits, and Gyftr features.
        *   The `loyaltyDiscountText` message is conditional on the current page (`$store_page`).
        *   Includes several `JSON.stringify` console logs, suggesting debugging for the logic controlling loyalty/credits/Gyftr visibility.

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/Components/place-order/Discounts/Discounts.svelte`**
    *   **Timestamps:** Frequent updates between `17/11/2025, 23:52:04` and `18/11/2025, 12:45:43`.
    *   **Updates:** Manages discount application, display, and related UI elements.
        *   Consolidates a wide range of Svelte stores to manage discount state, including stacking, automatic discounts, gift cards, and partner offers.
        *   The `allAppliedOffers` reactive block constructs a list of applied discounts, determining their type (automatic, stacked, Cred offer), amount saved, and removability.
        *   Includes logic for re-applying credits (`store_reapplyEr`).
        *   Calculates `allowDiscountApplication` based on stacking configuration and number of clubbed discounts.
        *   Processes partner offers and filters available coupons based on screen width.
        *   Frequent minor changes (e.g., adding a `console.log`) suggest ongoing debugging and refinement of discount logic.

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/App.svelte`**
    *   **Timestamps:** Multiple updates between `18/11/2025, 12:22:24` and `18/11/2025, 12:40:55`.
    *   **Updates:** This is the main application component, orchestrating various sub-components and global state.
        *   Extensive use of Svelte stores for managing application-wide state (page, cart, merchant info, user details, analytics flags, etc.).
        *   Handles browser `onpopstate` events to manage navigation history and confirm exit flows, specifically for non-cash-to-prepaid scenarios and various popup/bottom sheet states.
        *   Includes logic for automatically showing a free gift popup if available for logged-in users.
        *   Processes `launch` messages from a parent iframe to initialize various stores with merchant-specific data, cookies, and user info.
        *   Attempts to retrieve/set session tokens from `localStorage` and cookies, with fallback for incognito mode detection.
        *   Includes duplicate `logEvent` calls for `checkout_assets_loaded` on 18/11/2025, 12:22:24, which might be a temporary debugging artifact.
        *   Adds `store_availableOffersCheck` to LoginStore imports, suggesting further integration with discount/offer logic.

### Patterns and Recurring Elements:

1.  **Svelte Stores for State Management:** A pervasive pattern is the heavy reliance on Svelte stores (`store_...`) for managing application state across different components. This indicates a highly reactive and component-based architecture where data flow is central.
2.  **Environment-Specific Configuration:** The `EnvironmentService.ts` file clearly shows the application's capability to operate in multiple environments (local, dev, qa, sandbox, production) with different API endpoints. This is crucial for development, testing, and production deployment.
3.  **Analytics Integration:** Many files, especially `ForeignAnalytics.ts`, `Merchant.svelte`, and `Contlo.ts`, are concerned with integrating various analytics platforms (Facebook Pixel, Google Analytics, WebEngage, MoEngage, Snapchat, Contlo, CleverTap, Klaviyo, etc.). There's a strong focus on tracking user actions, cart data, discounts, and payment events.
4.  **Discount and Offer Management:** The discount functionality is complex, involving:
    *   Multiple types of discounts (coupon, automatic, loyalty, gift card, Gyftr, partner acquisition).
    *   Stacking logic for discounts.
    *   Conditional application and display of discounts based on user type, cart state, and custom configurations.
    *   Confetti animations for successful discount applications.
5.  **Checkout Flow and UI Components:** `PaymentOptions.svelte`, `OrderSummary.svelte`, and `App.svelte` demonstrate a detailed checkout flow, including:
    *   Displaying payment methods and associated charges.
    *   Handling COD confirmations.
    *   Dynamically updating order summaries.
    *   Managing popups and bottom sheets for various user interactions (e.g., exit confirmation, free gifts).
6.  **Cookie and Local Storage Management:** The application frequently interacts with browser cookies and local storage to persist user sessions, tracking information (UTM parameters, Shopify session IDs), and temporary data (`kp_email`, `cash_to_prepaid`).
7.  **Debugging and Refinement:** The presence of `console.log` statements, commented-out code (especially different merchant IDs in `merchant.html`), and minor incremental changes in timestamps suggest an active development and debugging process. The `cart_total_price` validation in `Contlo.ts` and the duplicate `logEvent` in `App.svelte` are prime examples.
8.  **Security/Token Handling:** Functions like `XGokwikToken` and `getTokenName` in `EnvironmentService.ts`, along with `jwtTokensArray` and `localStorage.getItem(XGokwikToken())` in `Merchant.svelte`, indicate a system for managing session tokens securely across different environments and storage mechanisms (cookies, local storage).

In summary, the changes reflect ongoing development of a robust e-commerce checkout system with sophisticated discount handling, comprehensive analytics integration, and careful management of client-side state and browser interactions, including specific handling for different deployment environments and mobile user experiences.