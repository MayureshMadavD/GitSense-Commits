# Activity Summary for 13/11/2025

## 11:04:18
The `/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/common/services/ShippingDiscount.service.ts` file, last modified on `12/11/2025, 21:20:24`, serves as a central service for managing shipping discounts, offers, and various related aspects of the order and checkout flow.

**File-Specific Updates:**

*   **Extensive State Management:** The service heavily relies on Svelte stores, subscribing to numerous states from `CommonStore`, `OrderStore`, and `LoginStore` to access and react to real-time cart, order, user, and merchant information. This includes tracking discount codes, shipping methods, gift cards, available offers, and flags like `isAbandonCart` or `modified_cart`.
*   **Dynamic Configuration:** It incorporates dynamic configurations from `requestIdObject` to control features such as disabling discounts/COD with credits, auto-applying credits, showing discount confetti, and identifying available free gifts.
*   **API Orchestration:** It orchestrates calls to `discountShippingCall` (via `MerchantAPI`) and uses `createApiResponseQueue` to manage and sequentialize API responses, ensuring stable updates.
*   **UI/UX Enhancements:**
    *   Triggers a `confetti` animation upon successful application of specific discount types, improving user feedback.
    *   Manages loader states and `skipToPayment` logic to control the user's flow and provide appropriate loading experiences.
    *   Updates bottom sheet states for address listing/input.
*   **Key Bug Fixes/Improvements (Referenced by CHECKOUT IDs):**
    *   **CHECKOUT-15842:** Implements a crucial fix to handle gift cards on cart updates. If the cart has been modified and gift cards are present, it clears existing gift cards, re-fetches them, and reapplies them to ensure accuracy.
    *   **CHECKOUT-12982:** Contains logic to directly call payment methods under specific conditions, particularly when on `currentPage === 7` and relevant shipping or discount responses are received.
*   **Discount and Shipping Logic:**
    *   Clears API timers when discounts are removed, optimizing resource usage.
    *   Integrates specific logic for "Gyftr" discounts, including removal and re-application based on `placeOrder` status and current page.
    *   Manages shipping method selection, including conditional calls to `addressListingBottomSheet` if shipping options are available but no method is selected.
*   **Event Logging & Error Handling:**
    *   Logs specific events, such as `loyalty_points_applied`, with detailed context about credits and auto-application.
    *   Provides specific error messages for `invalidChannel` based on the merchant's app flow.
    *   Includes conditional error message management, specifically excluding UI display for UTM auto-application failures.
    *   Implements a `discount_shipping_retry` mechanism with a `setTimeout` for delayed shipping method selection under certain conditions.

**Patterns and Recurring Elements:**

*   **Svelte Store Dependency:** A significant pattern is the heavy reliance on Svelte stores for managing and reacting to application-wide state, indicating a highly reactive and interconnected architecture.
*   **Conditional Logic based on `currentPage`:** The variable `currentPage` (often checked for `currentPage === 7`) is a recurring condition, suggesting different flows or behaviors depending on the user's current stage in the checkout process, likely denoting the payment or review page.
*   **Integration with Multiple Services:** The file imports and interacts with numerous other service files (e.g., `MerchantAPI`, `EventService`, `GiftCard.service`, `Discounts.service`, `Helper.service`), highlighting its role as an orchestrator for various checkout-related functionalities.
*   **Focus on User Experience:** Recurring elements like confetti animation, loader management, and specific error message handling demonstrate a strong focus on providing a clear and responsive user experience during the discount and shipping stages of checkout.

## 14:04:17
The file `/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/common/services/ShippingDiscount.service.ts` was last modified on `12/11/2025, 21:20:24`.

This file appears to be a core service handling the complex logic for applying and managing shipping discounts within a checkout flow. Key updates and functionalities include:

*   **Extensive State Management:** The service heavily relies on Svelte stores (`CommonStore`, `OrderStore`, `LoginStore`) to subscribe to and react to numerous application states such as `gstInfo`, `discountCode`, `currentPage`, `giftCardData`, `selectedShippingMethod`, `merchantInfo`, `bottomSheetState`, and flags related to `skipToPayment`, `isAbandonCart`, and `isRedirectionFlowEnabled`. This indicates a highly interconnected module that responds to global application changes.
*   **Dynamic Configuration:** Several operational flags, such as `disable_discount_with_credits`, `disable_cod_with_credits`, `auto_apply_credits`, `show_discount_confetti`, and `disable_discount_application`, are dynamically pulled from `store_requestIdObject`, suggesting a configurable behavior based on request-specific settings.
*   **Asynchronous API Processing:** A `processDiscountShippingQueue` is utilized to ensure that API calls and their subsequent processing related to `discountShippingCall` occur in a structured and sequential manner, preventing race conditions or out-of-order updates.
*   **Discount Application and UI Feedback:** The `callShippingDiscountApi` function handles the application of discounts, including triggering a `confetti` animation for successful applications under specific conditions (e.g., valid coupon code, certain user types, or explicit configuration).
*   **Integrated Gift Card and Loyalty Logic:** The `processShippingDiscountResponse` function contains detailed logic for managing gift cards (reapplying or re-fetching them if the cart has been modified) and logging `loyalty_points_applied` events. It also interacts with `Gyftr` (a gift/rewards system) to apply or remove gyftr amounts based on the current state.
*   **Checkout Flow Orchestration:** The service plays a critical role in orchestrating different parts of the checkout. It can trigger `addressListingBottomSheet()`, call `callPaymentMethods()`, and manage the state of `store_skipToPayment` and `store_loader` based on shipping and discount response data.
*   **Conditional Error Management:** Error messages are managed conditionally, with specific handling for `invalidChannel` discounts and an exclusion for displaying errors related to "utm auto application failure" on the UI.
*   **Event Logging:** Integrates with an `EventService` to log various events like `loyalty_points_applied`, `logDiscountEvent`, and `shopifyAnalyticsCouponAppliedSuccess/Failed` for analytics and monitoring.
*   **Recurring Pattern:** A significant pattern is the extensive use of Svelte store subscriptions to propagate state changes across the application, making this service a central hub for discount and shipping-related logic that reacts to numerous data points. Many operations are conditional on `currentPage === 7`, suggesting a critical step in the checkout process.

## 15:04:22
The changes log details updates across different parts of a Gokwik PDP (Product Display Page) project, focusing on service logic, environment configurations, and an example merchant integration.

### File-Specific Updates:

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/common/services/ShippingDiscount.service.ts` (Timestamp: 12/11/2025, 21:20:24)**
    This file orchestrates the application of discounts and management of shipping options within the checkout flow. It demonstrates a heavy reliance on a centralized state management system, subscribing to numerous stores (`CommonStore`, `OrderStore`, `LoginStore`) to access and update application state related to GST info, discount codes, shipping methods, gift cards, loyalty programs (Gyftr, TwidPay, loyalty credits), merchant information, and UI states (e.g., bottom sheet, loader, "skip to payment" flags).
    Key functionalities include:
    *   `callShippingDiscountApi`: Initiates calls to the discount and shipping APIs, clears API timers on coupon removal, and conditionally triggers a confetti animation for successful discount applications. It includes logic for managing Gyftr (reapplying or removing based on `placeOrder` status) and handling shipping method selection and address listing based on API responses. It also logs loyalty point application events.
    *   `processShippingDiscountResponse`: Processes the API response to set shipping methods, shipping options, and discount details. It contains complex logic for re-applying gift cards when the cart is updated, calls payment methods under specific UI conditions, and manages loader states. It specifically excludes displaying error messages for UTM-related auto-application failures.
    *   The service incorporates a queue (`createApiResponseQueue`) to process discount and shipping API responses in an ordered manner.
    *   Extensive conditional logic is used to handle various scenarios, such as different redirection flows, abandonment cart states, and address input forms.

*   **`/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/public/merchant.html` (Timestamp: 13/11/2025, 14:31:36)**
    This HTML file serves as a local development or testing page for integrating the Gokwik SDK. It defines a `gokwikSdk` JavaScript utility (an Immediately Invoked Function Expression) with methods for `init`, `initCheckout`, `emit`, `on`, and `hideButton`.
    Key elements include:
    *   Dynamic injection of the `gokwik.js` script (typically from `http://localhost:8080/build/gokwik.js` for local development) into the page.
    *   Cookie management functions (`getCookieGk`, `setCookieGk`) to track `gk_landing_page` and `gk_orig_referrer`.
    *   A "click me" button that triggers the Gokwik checkout flow.
    *   A `window.merchantInfo` object is hardcoded, explicitly setting the `environment` to 'local' and including `mid`, `storeId`, and `fbpixel`. There are numerous commented-out `mid` values, indicating frequent switching between various merchant IDs for testing different environments (QA, sandbox, production, specific merchant stores like Neemans, Boat).
    *   The SDK integration uses `window.postMessage` to send `merchantInfo` to the Gokwik modal upon initialization or button click.
    *   It also includes an integration for a "privy-widget," a likely third-party marketing or promotions tool.
    *   The file's structure and commented-out configurations strongly suggest its use for development, debugging, and testing the Gokwik SDK integration across different merchant setups and environments.

### Patterns and Recurring Elements:

*   **Environment-Specific Configuration and Testing:** A strong pattern across the logs is the emphasis on different environments (dev, qa, sandbox, production, local).
    *   The `merchant.html` file explicitly sets the `environment` to 'local' and features extensive commented-out `mid` values for various test and production environments, clearly indicating a development and testing mindset for integration.
*   **Complex State Management:** The `ShippingDiscount.service.ts` file highlights a robust and granular state management approach, subscribing to many distinct stores for different data points, suggesting a sophisticated front-end application with a clear separation of concerns for data.
*   **Checkout Flow Centrality:** Both files directly relate to the checkout process. `ShippingDiscount.service.ts` manages the backend logic for discounts and shipping, while `merchant.html` demonstrates how a merchant would initiate the Gokwik checkout widget.
*   **Third-Party Integrations:** The presence of logic for `Gyftr`, `TwidPay`, and the `privy-widget` indicates that the Gokwik platform is designed to integrate with a variety of external services for loyalty, payments, and marketing.
*   **Dynamic Script Loading:** The `merchant.html` dynamically loads the `gokwik.js` script, which is a common pattern for SDK integrations to allow for flexible deployment and updates.

## 17:04:21
The file `/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/common/services/ShippingDiscount.service.ts`, last modified on 12/11/2025 at 21:20:24, contains core logic for handling shipping and discount calculations within the application. It imports numerous Svelte stores (from `CommonStore`, `OrderStore`, `LoginStore`) to manage application state such as `gstInfo`, `discountCode`, `selectedShippingMethod`, `giftCardData`, and various flags and configurations. The file defines `callShippingDiscountApi` and `processShippingDiscountResponse` functions. `callShippingDiscountApi` initiates discount/shipping calls, clears API timers, triggers a confetti animation for certain valid discounts, and handles the application or reapplication of 'Gyftr' discounts. It also logs loyalty point application events. `processShippingDiscountResponse` processes the API response, setting shipping methods, options, and discount details. Notably, it includes fixes for `CHECKOUT-15842` (reapplying gift cards on cart updates) and `CHECKOUT-12982` (calling payment methods under specific conditions). It also manages error messages and implements retry logic for discount shipping based on the number of shipping options.

The file `/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/src/common/services/EnvironmentService.ts`, last modified on 13/11/2025 at 14:31:15, is responsible for configuring various service URLs and authentication tokens based on the current environment (`env`). It subscribes to `store_merchanturl`, `store_environment`, and `store_cashToPrepaid` to determine the active settings. The file exports a series of functions such as `getHealthServiceBaseUrl`, `getAddressSuggestionBaseUrl`, `api_url`, `getCredUrl`, `experiment_url`, `twidpay_api`, `kp_api`, `cdn_path`, `analytics_api`, `analytics_api_v2`, `merchant_url`, `merchant_url_api`, and `proxy_service_url`. Each function dynamically constructs a base URL or path based on the `env` variable, supporting a wide range of development, QA, sandbox, and production environments. It also includes functions to provide environment-specific authentication tokens.

The file `/Users/mayuresh.madav/Documents/pdp/gokwik.pdp/public/merchant.html`, last modified on 13/11/2025 at 14:31:36, is an HTML page designed to simulate a merchant's website and demonstrate the integration of the Gokwik SDK. It includes a JavaScript IIFE (`gokwikSdk`) that handles the initialization and interaction with the SDK. This SDK dynamically loads the `gokwik.js` script (from `http://localhost:8080/build/gokwik.js` by default), manages custom events, and provides a function to hide Gokwik buttons. The page uses `document.onreadystatechange` and a custom `initGKJS` event listener to initialize the SDK. It also implements simple cookie tracking for `gk_landing_page` and `gk_orig_referrer`. The HTML body contains a "click me" button that triggers the SDK checkout process and a `window.merchantInfo` object within a script tag, which is used for testing and configuring the SDK with specific merchant details and environment settings.

**Patterns and Recurring Elements:**

*   **Svelte Store Integration:** A dominant pattern is the extensive use of Svelte stores (e.g., `store_gstInfo`, `store_discountCode`) for managing and subscribing to application-wide state. This indicates a reactive, state-driven architecture.
*   **Environment-Specific Configuration:** Both `EnvironmentService.ts` and `merchant.html` heavily rely on an `env` variable or `window.merchantInfo.environment` to determine API endpoints, script sources, and other operational parameters, facilitating deployment across different stages (dev, qa, sandbox, production, local).
*   **Checkout Flow Focus:** The changes primarily revolve around the checkout experience, including discounts, shipping, gift cards, loyalty programs, and payment options.
*   **API Interaction:** The `ShippingDiscount.service.ts` file clearly outlines interactions with `discountShippingCall` and `updateCart` APIs, indicating a service-oriented architecture.
*   **Event Logging and Analytics:** There are explicit calls to `fireGtmEvent`, `logEvent`, `stabilityEvent`, `logDiscountEvent`, and references to Shopify analytics, suggesting a strong focus on tracking user behavior and system stability.
*   **Dynamic Script Loading:** `merchant.html` demonstrates dynamic loading of the Gokwik SDK and an analytics script, indicating a flexible and modular approach to front-end integration.
*   **Bug Fixes and Enhancements:** References to specific ticket numbers (e.g., `CHECKOUT-15842`, `CHECKOUT-12982`) within the `ShippingDiscount.service.ts` file highlight ongoing maintenance and feature development.